# Puppet
Puppet (маріонетка) – це популярний інструмент для управління конфігурацією, який дозволяє автоматизувати налаштування серверів, управління програмним забезпеченням та їх конфігурацію. Puppet використовує декларативний підхід, що дозволяє визначити бажаний стан системи, після чого самостійно застосовує необхідні зміни для досягнення цього стану.

## Основні компоненти Puppet:
- `Master` (керівник): Центральний сервер, який контролює управління конфігурацією. Він зберігає всі конфігурації, правила і модули.

- `Agent` (агент): Інстальований на кожному сервері, який управляється Puppet. Агент регулярно звертається до мастера для отримання інструкцій та застосування конфігурацій.

- `Manifests` (маніфести): Це файли, які описують конфігурації ресурсів у форматі, зрозумілому Puppet. Маніфести визначають, як повинні виглядати різні компоненти системи.

- `Modules` (модулі): Пакети, що містять маніфести, файли ресурсів та інші файли, які можуть бути повторно використані в різних проектах. Модулі дозволяють організувати та структурувати конфігурації.

- `Resources` (ресурси): Це окремі елементи управління, такі як пакети, служби, файли тощо, які Puppet може контролювати. Кожен ресурс має власні атрибути, які визначають його стан.

## Переваги використання Puppet:
- `Автоматизація`: Зменшує ручну роботу з налаштуванням серверів і управлінням конфігураціями.
- `Консистентність`: Забезпечує однаковість конфігурацій на різних серверах, зменшуючи ризик помилок.
- `Масштабованість`: Легко управляти великими кластерами серверів.
- `Аудит і звітність`: Можливість контролювати зміни та стежити за станом системи.

## Ляльковий ресурс
Ляльковий ресурс (Puppet resource) – це базовий елемент, який Puppet контролює. Це може бути будь-який компонент системи, з яким потрібно працювати, наприклад:

- `Пакет`: Установлений пакет програмного забезпечення.
- `Файл`: Конфігураційний файл або будь-який інший файл у файловій системі.
- `Служба`: Служба, яка повинна бути запущена або зупинена.

Кожен ресурс має свої атрибути, які визначають, в якому стані він повинен бути (наприклад, файл повинен бути певного типу, пакет має бути встановлений, а служба – запущена).

 
## Приклад налаштування Puppet для управління конфігурацією сервера. 
У цьому прикладі ми створимо простий модуль Puppet, який встановлює веб-сервер Apache на Ubuntu, налаштовує його, а також забезпечує, щоб він запускався автоматично при завантаженні системи.

### Кроки налаштування
1. Встановлення Puppet

   Перш ніж почати, переконайтеся, що Puppet встановлений на вашій машині. Ви можете це зробити, виконавши такі команди:

```bash
sudo apt update
sudo apt install puppet
```

2. Створення модуля Puppet

   Для створення модуля, відкрийте термінал і виконайте такі команди:

```bash
sudo puppet module generate myorg-apache
```
Це створить базову структуру модуля.

3. Редагування файлів модуля

    Перейдіть до каталогу, створеного для модуля:

```bash
cd /etc/puppet/modules/myorg-apache
```

   Відкрийте файл init.pp у каталозі manifests для редагування:

```bash
sudo nano manifests/init.pp
```

4. Додавання конфігурації для установки Apache

   Вставте наступний код у файл init.pp:

```puppet
class myorg::apache {
    # Встановлення пакету Apache
    package { 'apache2':
        ensure => installed,
    }

    # Запуск служби Apache
    service { 'apache2':
        ensure => running,
        enable => true,
        subscribe => Package['apache2'],  # Перезапустити службу при установці пакету
    }

    # Копіювання файлу конфігурації
    file { '/etc/apache2/sites-available/000-default.conf':
        ensure  => file,
        source  => 'puppet:///modules/myorg-apache/000-default.conf',
        notify  => Service['apache2'],  # Перезапустити службу при зміні файлу
    }
}
```

   Опис властивостей
   - `class myorg::apache:`  Це оголошення класу. Класи в Puppet дозволяють групувати ресурси, щоб їх можна було використовувати разом. У цьому випадку ми створюємо клас myorg::apache, який містить усі ресурси, пов'язані з Apache.
   - `package { 'apache2': ... }:`
      - `package`: Цей ресурс управляє пакетами. В даному випадку ми використовуємо його для установки пакету Apache.
      - `'apache2'`: Ім'я пакету, який ми хочемо встановити.
   - `ensure => installed`: Ця властивість визначає бажаний стан пакету. В даному випадку installed означає, що пакет повинен бути встановлений. Інші значення можуть включати absent (для видалення пакету) або latest (для установки останньої версії).
   - `service { 'apache2': ... }:`
      - `service`: Цей ресурс управляє службами (демонами) на сервері.
      - `'apache2'`: Ім'я служби, яку ми хочемо контролювати.
   - `ensure => running`: Ця властивість вказує, що служба повинна бути запущена. Можливі значення: running, stopped або true/false.
   - `enable => true`: Ця властивість визначає, чи служба повинна автоматично запускатися при завантаженні системи. Якщо встановлено true, служба буде включена в список автоматичного запуску.
   - `subscribe => Package['apache2']`: Ця властивість вказує, що служба повинна перезапускатися, якщо ресурс пакету apache2 змінюється (наприклад, якщо пакет буде перевстановлено або оновлено).
   - `file { '/etc/apache2/sites-available/000-default.conf': ... }:`
      - `file`: Цей ресурс управляє файлами і каталогами на файловій системі.
      - `'/etc/apache2/sites-available/000-default.conf'`: Шлях до файлу, який ми хочемо управляти.
   - `ensure => file`: Ця властивість вказує, що ресурс повинен бути файлом. Інші можливі значення: directory (для каталогів) або absent (для видалення файлу/каталогу).
   - `source => 'puppet:///modules/myorg-apache/000-default.conf'`: Ця властивість визначає джерело файлу, яке буде скопійовано в зазначене місце. puppet:/// є URI, який вказує на те, що файл знаходиться в модулях Puppet.
   - `notify => Service['apache2']`: Ця властивість вказує, що служба apache2 повинна бути перезапущена, якщо файл конфігурації змінюється.

5. Створення конфігураційного файлу Apache

   Тепер створіть файл конфігурації Apache, який ви вказали в коді вище. Для цього виконайте наступні команди:

```bash
sudo nano files/000-default.conf
```
   Додайте наступну конфігурацію до файлу:


```apache
<VirtualHost *:80>
    DocumentRoot /var/www/html
    <Directory /var/www/html>
        AllowOverride All
    </Directory>
</VirtualHost>
```
6. Застосування конфігурації Puppet

   Після того як ви створили модуль і налаштували конфігурацію, ви можете застосувати його до сервера. Для цього запустіть команду:

```bash
sudo puppet apply -e "include myorg::apache"
```

## Перевірка
Після виконання цих кроків, ви можете перевірити, чи Apache працює, відкривши веб-браузер і перейшовши за адресою http://localhost. Якщо все налаштовано правильно, ви повинні побачити сторінку Apache.

## Факти в Puppet
Факти (facts) у Puppet — це інформація про вузли (агенти), яка зберігається у вигляді ключ-значення. Ці факти збираються за допомогою інструменту Facter і використовуються для прийняття рішень під час управління конфігурацією.

Факти можуть бути стандартними, такі як версія операційної системи, IP-адреса, кількість процесорів, але також користувач може створювати власні факти для конкретних потреб.

### Приклад стандартних фактів:
  - `os`: інформація про операційну систему (назва, реліз).
  - `ipaddress`: IP-адреса машини.
  - `memory`: інформація про оперативну пам'ять.
  - `hostname`: ім'я вузла.
  - `processorcount`: кількість процесорів.
    
### Створення користувацьких фактів:
Користувацькі факти можна створювати як у вигляді простих файлів з Ruby-кодом, так і через Puppet-файли.

## Синтаксис

У Puppet є кілька способів використовувати факти й працювати з умовними логічними конструкціями. Ось різні варіанти синтаксису для використання фактів та умов у Puppet.

1. Просте використання ресурсу
   
   Найпростіший спосіб використання ресурсу в Puppet — це визначення ресурсу без умов.

```puppet
package { 'vim':
  ensure => installed,
}
```
   У цьому прикладі пакет vim буде встановлено незалежно від будь-яких умов.

2. Умовні конструкції (if-else)
   
   Конструкція if-else дозволяє виконувати умови на основі фактів або змінних.

```puppet
if $facts['os']['name'] == 'Ubuntu' {
  package { 'apache2':
    ensure => installed,
  }
} else {
  package { 'httpd':
    ensure => installed,
  }
}
```
   У цьому прикладі залежно від операційної системи буде встановлено або apache2, або httpd.

3. Використання фактів з розгалуженням (if)
   
```puppet
if $facts['is_virtual'] {
  package { 'qemu-guest-agent':
    ensure => installed,
  }
}
```
   У цьому прикладі, якщо система є віртуальною, буде встановлено пакет qemu-guest-agent.

4. Конструкція unless
   
   unless працює аналогічно до if, але умова заперечується.

```puppet
unless $facts['os']['name'] == 'Ubuntu' {
  package { 'vim-enhanced':
    ensure => installed,
  }
}
```
   Цей код встановлює vim-enhanced, якщо ОС не є Ubuntu.

5. Конструкція case
   
   Конструкція case зручна для перевірки кількох варіантів.

```puppet
case $facts['os']['name'] {
  'Ubuntu': {
    package { 'apache2':
      ensure => installed,
    }
  }
  'CentOS': {
    package { 'httpd':
      ensure => installed,
    }
  }
  default: {
    package { 'nginx':
      ensure => installed,
    }
  }
}
```
   Цей код встановлює apache2 для Ubuntu, httpd для CentOS, а для інших систем — nginx.

6. Використання selector для вибору значень
   
   Selector дозволяє вам задавати значення на основі умови без використання явних розгалужень if.

```puppet
$webserver_package = $facts['os']['name'] ? {
  'Ubuntu' => 'apache2',
  'CentOS' => 'httpd',
  default  => 'nginx',
}

package { $webserver_package:
  ensure => installed,
}
```
   У цьому прикладі змінна $webserver_package отримує різні значення залежно від ОС, і пакет вибирається автоматично.

7. Декларативний стиль без розгалуження
   
   Іноді розгалуження не потрібне. Наприклад, при роботі з простими ресурсами.

```puppet
user { 'john':
  ensure     => present,
  managehome => true,
  home       => '/home/john',
}

file { '/home/john/.bashrc':
  ensure  => file,
  content => 'export PATH=/usr/local/bin:$PATH',
}
```
   Цей код створює користувача john і задає зміст для його .bashrc.

8. Конструкція defined()
   
   Можна використовувати функцію defined() для перевірки, чи існує ресурс або клас.

```puppet
if ! defined(Package['vim']) {
  package { 'vim':
    ensure => installed,
  }
}
``` 
   Цей код перевіряє, чи не встановлено ще vim, і тільки в такому випадку встановлює його.

9. Логічні операції у конструкціях if
    
   Можна комбінувати кілька умов за допомогою логічних операторів.

```puppet
if $facts['os']['name'] == 'Ubuntu' and $facts['os']['release']['major'] == '20.04' {
  package { 'docker':
    ensure => installed,
  }
}
```
10. Класи та використання фактів у класах
    
   Ви можете використовувати факти й умови в класах для створення більш складної конфігурації.

```puppet
class webserver {
  case $facts['os']['name'] {
    'Ubuntu': {
      package { 'apache2':
        ensure => installed,
      }
    }
    'CentOS': {
      package { 'httpd':
        ensure => installed,
      }
    }
  }
}

include webserver
```
   У цьому прикладі клас webserver налаштовує різні пакети залежно від ОС.

### Підсумок
- `Простий ресурс`: Використовується для створення/керування одним ресурсом без умов.
- `if-else`: Використовується для умовної логіки.
- `unless`: Виконує ресурс, якщо умова не виконується.
- `case`: Кілька варіантів умов для вибору дій.
- `selector`: Спрощений синтаксис для вибору значення без явного розгалуження.
- `defined()`: Перевірка, чи існує вже ресурс.
- `Логічні оператори`: Використання and, or для комбінування умов.
- `Класи`: Використання класів для структурування коду та умов.

Ці конструкції дозволяють будувати гнучкі маніфести Puppet для управління конфігураціями систем.

